<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tanda Tangan Digital</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: black;
      color: white;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
      position: relative;
    }
    section {
      border: 4px solid;
      border-radius: 1rem;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 0 20px;
    }
    .neon-green {
      border-color: #39FF14;
      box-shadow: 0 0 20px #39FF14;
    }
    .neon-blue {
      border-color: #00FFFF;
      box-shadow: 0 0 20px #00FFFF;
    }
    h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    p {
      font-size: 1.25rem;
      color: #ccc;
      max-width: 600px;
      margin: 0 auto 2rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background-color: #00ffff;
      color: black;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      margin: 0.5rem;
    }
    canvas {
      background-color: white;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
      align-items: center;
    }
    footer {
      text-align: center;
      padding: 2rem;
      color: #888;
    }
    input[type="file"], input[type="number"] {
      display: block;
      margin: 1rem 0;
    }
    #pdf-preview-wrapper {
      position: relative;
    }
    #pdf-preview {
      display: block;
      margin: 2rem auto;
      border: 1px solid #ccc;
      background: white;
      width: 100%;
      max-height: 600px;
    }
    #signature-wrapper {
      position: absolute;
      z-index: 10;
      cursor: move;
      border: 2px dashed #00ffff;
      border-radius: 4px;
      max-width: 150px;
    }
    #signature-draggable {
      display: block;
      max-width: 100%;
      height: auto;
    }
    .resizer {
      width: 10px;
      height: 10px;
      background: #00ffff;
      position: absolute;
      right: -5px;
      bottom: -5px;
      cursor: se-resize;
    }
    .color-picker {
      margin-top: 1rem;
    }
    .color-picker label {
      margin-right: 1rem;
    }
    #page-info {
      font-size: 1rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="neon-green">Tanda Tangan Digital</h1>

    <section class="neon-blue">
      <h2>Unggah Dokumen PDF</h2>
      <input type="file" id="pdf-upload" accept="application/pdf" />
      <div id="page-info">Halaman <span id="current-page">1</span> dari <span id="total-pages">1</span></div>
      <div class="button-row">
        <button onclick="prevPage()">◀ Sebelumnya</button>
        <input type="number" id="goto-page" min="1" value="1" style="width: 60px" onchange="goToPage(this.value)" />
        <button onclick="nextPage()">Berikutnya ▶</button>
      </div>
      <div id="pdf-preview-wrapper">
        <canvas id="pdf-preview"></canvas>
        <div id="signature-wrapper" style="display:none;">
          <img id="signature-draggable" />
          <div class="resizer"></div>
        </div>
      </div>
    </section>

    <section class="neon-blue">
      <h2>Buat Tanda Tangan</h2>
      <canvas id="signature-pad" width="400" height="150" style="border:1px solid #ccc;"></canvas>
      <div class="color-picker">
        <label><input type="radio" name="penColor" value="black" checked> Hitam</label>
        <label><input type="radio" name="penColor" value="blue"> Biru</label>
        <label><input type="radio" name="penColor" value="red"> Merah</label>
      </div>
      <div class="button-row">
        <button onclick="clearSignature()">Hapus</button>
        <button onclick="saveSignature()">Simpan Tanda Tangan</button>
      </div>
    </section>

    <section class="neon-blue">
      <h2>Atur Posisi Tanda Tangan</h2>
      <p>Geser tanda tangan ke posisi yang diinginkan di halaman PDF.</p>
      <div class="button-row">
        <button onclick="lockSignaturePosition()">Simpan Posisi</button>
        <button onclick="downloadSignedPDF()">Download PDF Bertanda Tangan</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 1;
    let signaturePad;
    let savedSignatureDataURL = "";

    document.getElementById('pdf-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function () {
          const typedArray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedArray).promise.then(pdf => {
            pdfDoc = pdf;
            totalPages = pdfDoc.numPages;
            document.getElementById('total-pages').textContent = totalPages;
            renderPage(currentPage);
          });
        };
        fileReader.readAsArrayBuffer(file);
      }
    });

    function renderPage(pageNum) {
      pdfDoc.getPage(pageNum).then(page => {
        const canvas = document.getElementById('pdf-preview');
        const context = canvas.getContext('2d');
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        page.render(renderContext);

        document.getElementById('current-page').textContent = pageNum;
        document.getElementById('goto-page').value = pageNum;
      });
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    }

    function goToPage(num) {
      const n = parseInt(num);
      if (n >= 1 && n <= totalPages) {
        currentPage = n;
        renderPage(currentPage);
      }
    }

    const canvas = document.getElementById("signature-pad");
    signaturePad = new SignaturePad(canvas);

    document.querySelectorAll('input[name="penColor"]').forEach(el => {
      el.addEventListener('change', e => {
        signaturePad.penColor = e.target.value;
      });
    });

    function clearSignature() {
      signaturePad.clear();
    }

    function saveSignature() {
      if (!signaturePad.isEmpty()) {
        savedSignatureDataURL = signaturePad.toDataURL();
        const wrapper = document.getElementById("signature-wrapper");
        const img = document.getElementById("signature-draggable");
        wrapper.style.display = "block";
        img.src = savedSignatureDataURL;
        wrapper.style.left = "20px";
        wrapper.style.top = "20px";
        makeDraggable(wrapper);
        makeResizable(wrapper, wrapper.querySelector('.resizer'));
      }
    }

    function makeDraggable(elmnt) {
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      elmnt.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    function makeResizable(elmnt, resizer) {
      resizer.addEventListener("mousedown", initResize);
      function initResize(e) {
        e.preventDefault();
        window.addEventListener("mousemove", Resize);
        window.addEventListener("mouseup", stopResize);
      }
      function Resize(e) {
        elmnt.style.width = (e.clientX - elmnt.offsetLeft) + "px";
        elmnt.style.height = (e.clientY - elmnt.offsetTop) + "px";
      }
      function stopResize() {
        window.removeEventListener("mousemove", Resize);
        window.removeEventListener("mouseup", stopResize);
      }
    }

    function lockSignaturePosition() {
      const wrapper = document.getElementById("signature-wrapper");
      if (wrapper) wrapper.style.pointerEvents = "none";
    }

    async function downloadSignedPDF() {
      const pdfFile = document.getElementById("pdf-upload").files[0];
      if (!pdfFile) return alert("Silakan unggah file PDF terlebih dahulu.");

      const reader = new FileReader();
      reader.onload = async function () {
        const existingPdfBytes = new Uint8Array(this.result);
        const pdfDocLib = await PDFLib.PDFDocument.load(existingPdfBytes);

        const img = document.getElementById("signature-draggable");
        const wrapper = document.getElementById("signature-wrapper");
        const canvasRect = document.getElementById("pdf-preview").getBoundingClientRect();
        const wrapperRect = wrapper.getBoundingClientRect();

        const pngUrl = savedSignatureDataURL;
        const signatureImage = await pdfDocLib.embedPng(pngUrl);

        const pages = pdfDocLib.getPages();
        const targetPage = pages[currentPage - 1];
        const { width, height } = targetPage.getSize();

        const scaleX = width / canvasRect.width;
        const scaleY = height / canvasRect.height;

        const x = (wrapperRect.left - canvasRect.left) * scaleX;
        const y = height - ((wrapperRect.top - canvasRect.top) + wrapper.offsetHeight) * scaleY;

        targetPage.drawImage(signatureImage, {
          x: x,
          y: y,
          width: wrapper.offsetWidth * scaleX,
          height: wrapper.offsetHeight * scaleY,
        });

        const pdfBytes = await pdfDocLib.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "tanda-tangan.pdf";
        link.click();
      };
      reader.readAsArrayBuffer(pdfFile);
    }
  </script>
</body>
</html>
